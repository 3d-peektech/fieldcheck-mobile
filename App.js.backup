import React, { useEffect } from 'react';
import { StatusBar, Platform, LogBox } from 'react-native';
import { SafeAreaProvider } from 'react-native-safe-area-context';
import { NavigationContainer } from '@react-navigation/native';
import { StripeProvider } from '@stripe/stripe-react-native';
import * as Notifications from 'expo-notifications';
import * as SplashScreen from 'expo-splash-screen';

// ==================== NAVIGATION ====================
import AppNavigator from './src/navigation/AppNavigator';

// ==================== CONTEXT PROVIDERS ====================
import { AuthProvider } from './src/context/AuthContext';
import { ThemeProvider } from './src/context/ThemeContext';

// ==================== CONSTANTS ====================
const STRIPE_PUBLISHABLE_KEY = 'pk_test_your_key_here'; // TODO: Replace with your key

// ==================== NOTIFICATION HANDLER ====================
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true,
  }),
});

// ==================== IGNORE LOGS (OPTIONAL) ====================
LogBox.ignoreLogs([
  'Non-serializable values were found in the navigation state',
  'ViewPropTypes will be removed',
]);

// Keep splash screen visible while loading
SplashScreen.preventAutoHideAsync();

// ==================== DEEP LINKING CONFIGURATION ====================
const linking = {
  prefixes: ['fieldcheck://', 'https://fieldcheck.app'],
  config: {
    screens: {
      // Auth Screens
      Onboarding: 'onboarding',
      Login: 'login',
      Register: 'register',
      ForgotPassword: 'forgot-password',
      
      // Main App
      Main: {
        screens: {
          Home: {
            screens: {
              DashboardScreen: 'home',
              AssetDetails: 'assets/:assetId',
              InspectionDetails: 'inspections/:inspectionId',
              AIAnalysis: 'ai-analysis',
              ScanAsset: 'scan',
              NewInspection: 'inspection/new',
              AddAsset: 'asset/new',
            },
          },
          Assets: {
            screens: {
              AssetsListScreen: 'assets',
              AssetDetails: 'assets/:assetId',
              AddAsset: 'assets/new',
              EditAsset: 'assets/:assetId/edit',
              AssetHistory: 'assets/:assetId/history',
              AssetQRCode: 'assets/:assetId/qr',
              NewInspection: 'inspection/new',
              InspectionDetails: 'inspections/:inspectionId',
            },
          },
          Inspections: {
            screens: {
              InspectionsListScreen: 'inspections',
              InspectionDetails: 'inspections/:inspectionId',
              NewInspection: 'inspections/new',
              EditInspection: 'inspections/:inspectionId/edit',
              AIAnalysis: 'ai-analysis',
              AssetDetails: 'assets/:assetId',
            },
          },
          Profile: {
            screens: {
              ProfileMain: 'profile',
              Settings: 'settings',
              EditProfile: 'profile/edit',
              ChangePassword: 'profile/password',
              ExportData: 'profile/export',
              Subscription: 'subscription',
              Billing: 'billing',
              Invoices: 'invoices',
              PaymentMethods: 'payment-methods',
              PaymentSuccess: 'payment-success',
            },
          },
        },
      },
      
      // Modal Screens
      Notifications: 'notifications',
      HelpCenter: 'help',
      TermsAndPrivacy: {
        path: 'legal/:tab',
        parse: {
          tab: (tab) => tab,
        },
      },
    },
  },
};

// ==================== MAIN APP COMPONENT ====================
export default function App() {
  useEffect(() => {
    // Initialize app
    initializeApp();
    
    // Setup notification listeners
    const notificationListener = Notifications.addNotificationReceivedListener(
      handleNotificationReceived
    );
    
    const responseListener = Notifications.addNotificationResponseReceivedListener(
      handleNotificationResponse
    );

    return () => {
      notificationListener.remove();
      responseListener.remove();
    };
  }, []);

  const initializeApp = async () => {
    try {
      // Request notification permissions
      if (Platform.OS !== 'web') {
        const { status } = await Notifications.requestPermissionsAsync();
        if (status !== 'granted') {
          console.log('Notification permission not granted');
        }
      }

      // Hide splash screen after a short delay
      setTimeout(() => {
        SplashScreen.hideAsync();
      }, 1000);
    } catch (error) {
      console.error('Error initializing app:', error);
      SplashScreen.hideAsync();
    }
  };

  const handleNotificationReceived = (notification) => {
    console.log('Notification received:', notification);
    // Handle foreground notification
  };

  const handleNotificationResponse = (response) => {
    console.log('Notification response:', response);
    // Navigate based on notification data
    const data = response.notification.request.content.data;
    if (data?.screen) {
      // navigationRef.current?.navigate(data.screen, data.params);
    }
  };

  return (
    <SafeAreaProvider>
      <ThemeProvider>
        <StripeProvider publishableKey={STRIPE_PUBLISHABLE_KEY}>
          <AuthProvider>
            <NavigationContainer
              linking={linking}
              fallback={null}
              onReady={() => {
                console.log('Navigation ready');
              }}
              onStateChange={(state) => {
                // Analytics tracking
                // const currentScreen = getActiveRouteName(state);
                // Analytics.setCurrentScreen(currentScreen);
              }}
            >
              <StatusBar
                barStyle="light-content"
                backgroundColor="#10B981"
                translucent={false}
              />
              <AppNavigator />
            </NavigationContainer>
          </AuthProvider>
        </StripeProvider>
      </ThemeProvider>
    </SafeAreaProvider>
  );
}

// ==================== HELPER FUNCTIONS ====================
const getActiveRouteName = (state) => {
  if (!state || typeof state.index !== 'number') {
    return 'Unknown';
  }

  const route = state.routes[state.index];

  if (route.state) {
    return getActiveRouteName(route.state);
  }

  return route.name;
};